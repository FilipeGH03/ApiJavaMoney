# üîê GUIA DE TESTES - API Algamoney com OAuth2 JWT

## üìã Credenciais
- **Username:** admin
- **Password:** admin

---

## üöÄ TESTE 1: Login (Obter Token JWT)

### Postman / Insomnia:
```
M√©todo: POST
URL: http://localhost:8080/oauth/token
Headers:
  Content-Type: application/json

Body (JSON):
{
  "username": "admin",
  "password": "admin"
}
```

### Resposta Esperada:
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJhbGdhbW9uZXktYXBpIiwic3ViIjoiYWRtaW4iLCJleHAiOjE3MzE0MzQwMDAsImlhdCI6MTczMTQzMDQwMCwic2NvcGUiOiJST0xFX1JPTEUifQ...",
  "refresh_token": "e8b3a4c1-5f7d-4a9b-8c2e-3d6f1a9b7c4e",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

**üìù IMPORTANTE:** 
- Copie o `access_token` - voc√™ vai usar nas requisi√ß√µes normais!
- Copie o `refresh_token` - voc√™ vai usar para renovar o access_token quando ele expirar!

---

## üîì TESTE 2: Endpoint P√∫blico (Sem Token)

### GET Categorias (N√£o precisa de token)
```
M√©todo: GET
URL: http://localhost:8080/categorias
Authorization: No Auth (ou deixe vazio)
```

### Resposta: Lista de categorias (200 OK)
```json
[
  {
    "codigo": 1,
    "nome": "Alimenta√ß√£o"
  },
  {
    "codigo": 2,
    "nome": "Sa√∫de"
  }
]
```

---

## üîí TESTE 3: Endpoint Protegido COM Token

### GET Pessoas (Requer token JWT)

#### No Postman:
```
M√©todo: GET
URL: http://localhost:8080/pessoas

Authorization:
  Type: Bearer Token
  Token: [Cole aqui o access_token que voc√™ copiou do Login]
```

#### Alternativa - Header Manual:
```
M√©todo: GET
URL: http://localhost:8080/pessoas
Headers:
  Authorization: Bearer eyJhbGciOiJSUzI1NiJ9... (seu token completo)
```

### Resposta: Lista de pessoas (200 OK)

---

## üîí TESTE 4: GET Lan√ßamentos com Filtro

### Requisi√ß√£o:
```
M√©todo: GET
URL: http://localhost:8080/lancamentos?descricao=aluguel

Authorization:
  Type: Bearer Token
  Token: [Seu access_token]
```

### Resposta: Lan√ßamentos filtrados por descri√ß√£o

---

## üîí TESTE 5: POST Criar Lan√ßamento

### Requisi√ß√£o:
```
M√©todo: POST
URL: http://localhost:8080/lancamentos

Headers:
  Content-Type: application/json

Authorization:
  Type: Bearer Token
  Token: [Seu access_token]

Body (JSON):
{
  "descricao": "Aluguel de Dezembro",
  "data_vencimento": "2024-12-05",
  "valor": 1500.00,
  "tipo": "DESPESA",
  "categoria": {
    "codigo": 3
  },
  "pessoa": {
    "codigo": 1
  }
}
```

### Resposta: Lan√ßamento criado (201 Created)

---

## ‚ùå TESTE 6: Requisi√ß√£o SEM Token (Deve Falhar)

### Requisi√ß√£o:
```
M√©todo: GET
URL: http://localhost:8080/pessoas
Authorization: No Auth
```

### Resposta Esperada: 401 Unauthorized
```json
{
  "timestamp": "2025-11-12T14:30:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "Full authentication is required to access this resource",
  "path": "/pessoas"
}
```

---

## üîÑ TESTE 7: Renovar Token com Refresh Token

Quando o `access_token` expirar (ap√≥s 1 hora), voc√™ pode usar o `refresh_token` para obter um novo sem precisar fazer login novamente!

### Requisi√ß√£o:
```
M√©todo: POST
URL: http://localhost:8080/oauth/token/refresh

Headers:
  Content-Type: application/json

Body (JSON):
{
  "refresh_token": "e8b3a4c1-5f7d-4a9b-8c2e-3d6f1a9b7c4e"
}
```

### Resposta Esperada:
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiJ9... (novo token)",
  "refresh_token": "e8b3a4c1-5f7d-4a9b-8c2e-3d6f1a9b7c4e",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

**üìù IMPORTANTE:**
- O `refresh_token` √© v√°lido por **30 dias**
- Use o novo `access_token` para suas pr√≥ximas requisi√ß√µes
- Voc√™ pode renovar quantas vezes quiser durante esses 30 dias
- Se o `refresh_token` expirar, voc√™ precisar√° fazer login novamente

---

## ‚ùå TESTE 8: Token Expirado (Ap√≥s 1 hora)

Ap√≥s 1 hora (3600 segundos), o access_token expira.

### Resposta Esperada: 401 Unauthorized
```json
{
  "error": "invalid_token",
  "error_description": "Token has expired"
}
```

**Solu√ß√£o:** Use o endpoint de refresh (TESTE 7) para obter um novo token, ou fa√ßa login novamente.

---

## üåê TESTE 9: Integra√ß√£o com Frontend (Angular/React)

### JavaScript (Fetch):
```javascript
// 1. Login
async function login() {
  const response = await fetch('http://localhost:8080/oauth/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      username: 'admin',
      password: 'admin'
    })
  });
  
  const data = await response.json();
  localStorage.setItem('access_token', data.access_token);
  localStorage.setItem('refresh_token', data.refresh_token);
  console.log('Tokens salvos!');
}

// 2. Renovar Token
async function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token');
  
  const response = await fetch('http://localhost:8080/oauth/token/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      refresh_token: refreshToken
    })
  });
  
  const data = await response.json();
  localStorage.setItem('access_token', data.access_token);
  console.log('Token renovado!');
}

// 3. Buscar Lan√ßamentos (com renova√ß√£o autom√°tica)
async function getLancamentos() {
  let token = localStorage.getItem('access_token');
  
  let response = await fetch('http://localhost:8080/lancamentos', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  const lancamentos = await response.json();
  console.log('Lan√ßamentos:', lancamentos);
}

// Executar
login().then(() => getLancamentos());
```

### Angular (HttpClient):
```typescript
import { HttpClient, HttpHeaders } from '@angular/common/http';

export class ApiService {
  private apiUrl = 'http://localhost:8080';
  
  constructor(private http: HttpClient) {}

  // Login
  login(username: string, password: string) {
    return this.http.post<any>(`${this.apiUrl}/oauth/token`, {
      username,
      password
    }).pipe(
      tap(response => {
        localStorage.setItem('access_token', response.access_token);
      })
    );
  }

  // GET com token
  getLancamentos() {
    const token = localStorage.getItem('access_token');
    const headers = new HttpHeaders({
      'Authorization': `Bearer ${token}`
    });
    
    return this.http.get(`${this.apiUrl}/lancamentos`, { headers });
  }

  // POST com token
  criarLancamento(lancamento: any) {
    const token = localStorage.getItem('access_token');
    const headers = new HttpHeaders({
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    });
    
    return this.http.post(`${this.apiUrl}/lancamentos`, lancamento, { headers });
  }
}
```

---

## üìä RESUMO DOS ENDPOINTS

| Endpoint | M√©todo | Autentica√ß√£o | Descri√ß√£o |
|----------|--------|--------------|-----------|
| `/oauth/token` | POST | ‚ùå N√£o | Login - Retorna JWT token |
| `/categorias` | GET | ‚ùå N√£o | Lista categorias (p√∫blico) |
| `/categorias` | POST | ‚úÖ Sim | Criar categoria |
| `/pessoas` | GET | ‚úÖ Sim | Lista pessoas |
| `/pessoas` | POST | ‚úÖ Sim | Criar pessoa |
| `/pessoas/{codigo}` | GET | ‚úÖ Sim | Buscar pessoa por c√≥digo |
| `/pessoas/{codigo}` | PUT | ‚úÖ Sim | Atualizar pessoa |
| `/pessoas/{codigo}` | DELETE | ‚úÖ Sim | Deletar pessoa |
| `/pessoas/{codigo}/ativo` | PUT | ‚úÖ Sim | Atualizar status ativo |
| `/lancamentos` | GET | ‚úÖ Sim | Lista lan√ßamentos (com filtros) |
| `/lancamentos` | POST | ‚úÖ Sim | Criar lan√ßamento |

---

## üîß CONFIGURA√á√ïES CORS

**Origens permitidas:**
- http://localhost:4200 (Angular padr√£o)

**Para adicionar outras origens, edite:**
`ResourceServerConfig.java` ‚Üí m√©todo `corsConfigurationSource()`

```java
configuration.setAllowedOrigins(Arrays.asList(
    "http://localhost:4200",  // Angular
    "http://localhost:3000",  // React
    "http://localhost:8081"   // Vue.js
));
```

---

## ‚ö†Ô∏è TROUBLESHOOTING

### Erro: "Full authentication is required"
**Causa:** Token n√£o foi enviado ou est√° inv√°lido  
**Solu√ß√£o:** Verifique se est√° usando `Authorization: Bearer <token>` no header

### Erro: "Token has expired"
**Causa:** Token expirou (1 hora de validade)  
**Solu√ß√£o:** Fa√ßa login novamente para obter novo token

### Erro: "Bad credentials"
**Causa:** Username ou password incorretos  
**Solu√ß√£o:** Use admin/admin

### Erro: "CORS policy"
**Causa:** Frontend rodando em origem n√£o permitida  
**Solu√ß√£o:** Adicione a origem em `corsConfigurationSource()`

### Token n√£o funciona
**Causa:** Formato incorreto  
**Solu√ß√£o:** Use `Bearer ` (com espa√ßo) antes do token

---

## üìù NOTAS IMPORTANTES

1. ‚úÖ Token JWT expira em **1 hora** (3600 segundos)
2. ‚úÖ Token √© **stateless** - n√£o precisa armazenar no servidor
3. ‚úÖ Senha est√° **criptografada** com BCrypt
4. ‚úÖ CORS configurado para **http://localhost:4200**
5. ‚ö†Ô∏è Em produ√ß√£o, use HTTPS e tokens de refresh

---

## üéØ PR√ìXIMOS PASSOS

Para implementar em produ√ß√£o:
1. Adicionar **Refresh Token** (token de longa dura√ß√£o)
2. Armazenar usu√°rios em **banco de dados**
3. Adicionar **roles/permiss√µes** granulares
4. Usar **HTTPS** obrigatoriamente
5. Implementar **rate limiting**
6. Adicionar logs de auditoria

---

Criado por: GitHub Copilot
Data: 12/11/2025
